<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üéì CWHSROOM - Charles Wesley High School</title>
    <!-- Modern Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-navy: #0b1e33;
            --secondary-navy: #1e3a5f;
            --accent-gold: #f5b342;
            --accent-gold-light: #ffd966;
            --accent-gold-dark: #e69c2e;
            --text-light: #e6f1ff;
            --text-dark: #1e2a3a;
            --bg-light: #f8fafc;
            --bg-gray: #edf2f7;
            --danger: #ef4444;
            --success: #10b981;
            --font-primary: 'Poppins', sans-serif;
            --font-secondary: 'Montserrat', sans-serif;
            --font-elegant: 'Playfair Display', serif;
        }

        html, body {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        body {
            background: linear-gradient(145deg, var(--primary-navy), var(--secondary-navy));
            min-height: 100vh;
            color: var(--text-dark);
            font-family: var(--font-primary);
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary-navy);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            color: white;
            flex-direction: column;
            gap: 20px;
            font-family: var(--font-elegant);
        }

        .loader {
            border: 5px solid rgba(245, 179, 66, 0.3);
            border-top: 5px solid var(--accent-gold);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Alert */
        #customAlert {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 10001;
            display: none;
            max-width: 320px;
        }

        .alert-content {
            background: white;
            border-left: 5px solid;
            border-radius: 16px;
            padding: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border: 2px solid var(--accent-gold);
            font-family: var(--font-primary);
        }

        .alert-success { border-left-color: var(--success); }
        .alert-error { border-left-color: var(--danger); }
        .alert-icon {
            width: 36px; height: 36px; border-radius: 50%;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; margin-right: 10px;
        }
        .alert-success .alert-icon { background: var(--success); }
        .alert-error .alert-icon { background: var(--danger); }
        .alert-message { color: var(--text-dark); font-weight: 500; }

        /* Auth Pages */
        #signupPage, #loginPage {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            background: linear-gradient(145deg, var(--primary-navy), var(--secondary-navy));
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            z-index: 10000;
        }
        #loginPage { display: none; }

        .auth-card {
            width: 100%; max-width: 400px;
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(10px);
            padding: 2.5rem 2rem;
            border-radius: 32px;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        .auth-card h1 {
            color: var(--primary-navy);
            font-size: 3rem;
            text-align: center;
            margin-bottom: 0.2rem;
            font-family: var(--font-elegant);
            font-weight: 800;
            letter-spacing: 1px;
        }

        .auth-card .subtitle {
            text-align: center;
            color: var(--secondary-navy);
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 500;
        }

        .slogan {
            text-align: center;
            color: var(--accent-gold-dark);
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            font-family: var(--font-elegant);
            font-style: italic;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            background: rgba(245,179,66,0.1);
            padding: 0.5rem;
            border-radius: 30px;
        }

        .auth-card input, .auth-card select {
            width: 100%;
            padding: 1rem 1.2rem;
            margin: 0.5rem 0;
            background: var(--bg-light);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: all 0.3s;
        }

        .auth-card input:focus, .auth-card select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(245,179,66,0.2);
        }

        .auth-card button {
            width: 100%;
            padding: 1.2rem;
            margin: 1.5rem 0 1rem;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            border: 2px solid var(--accent-gold);
            transition: all 0.3s;
            font-family: var(--font-secondary);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .auth-card button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(245,179,66,0.4);
        }

        .auth-card button:disabled { opacity: 0.5; cursor: not-allowed; }

        .auth-card a {
            color: var(--primary-navy);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-card a:hover {
            color: var(--accent-gold-dark);
            text-decoration: underline;
        }

        .school-password-hint {
            text-align: center;
            color: var(--accent-gold-dark);
            font-size: 0.9rem;
            margin: 0.5rem 0;
            font-weight: 600;
            font-family: var(--font-secondary);
        }

        /* Admin badge styles */
        .admin-badge-founder {
            background: var(--accent-gold);
            color: var(--primary-navy);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            border: 1px solid var(--primary-navy);
            font-family: var(--font-secondary);
        }

        .admin-badge-principal {
            background: var(--primary-navy);
            color: var(--accent-gold);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            border: 1px solid var(--accent-gold);
            font-family: var(--font-secondary);
        }

        .admin-badge-deputy {
            background: #4a5568;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
            font-family: var(--font-secondary);
        }

        /* Main App */
        #mainApp {
            display: none;
            min-height: 100vh;
            background: var(--bg-light);
        }

        .top-bar {
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--accent-gold);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .school-badge {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .school-badge h2 {
            color: white;
            font-size: 1.6rem;
            font-family: var(--font-elegant);
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .slogan-small {
            color: var(--accent-gold);
            font-size: 0.9rem;
            font-family: var(--font-elegant);
            font-style: italic;
            background: rgba(0,0,0,0.2);
            padding: 0.2rem 1rem;
            border-radius: 30px;
        }

        .refresh-btn {
            background: var(--accent-gold);
            color: var(--primary-navy);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 6px 15px rgba(245,179,66,0.4);
        }

        #userMenuBtn {
            background: var(--accent-gold);
            color: var(--primary-navy);
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            font-family: var(--font-secondary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        #userMenuBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245,179,66,0.4);
        }

        /* Profile Section */
        #profileSection {
            margin: 1.5rem;
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            border: 4px solid var(--accent-gold);
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--accent-gold);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.8rem;
            color: var(--primary-navy);
            font-family: var(--font-elegant);
            margin-bottom: 0.3rem;
        }

        .profile-grade {
            color: var(--accent-gold-dark);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .profile-bio {
            color: #4a5568;
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            color: #718096;
            font-size: 0.9rem;
        }

        .edit-profile-btn {
            background: var(--primary-navy);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .edit-profile-btn:hover {
            background: var(--secondary-navy);
            transform: translateY(-2px);
        }

        /* Avatar Grid */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-gold);
        }

        .avatar-option.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px var(--accent-gold);
        }

        /* Admin Panel */
        #adminSection {
            margin: 1.5rem;
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .admin-header h3 {
            color: var(--primary-navy);
            font-family: var(--font-elegant);
            font-size: 1.5rem;
        }

        .admin-stats {
            background: var(--primary-navy);
            color: white;
            padding: 0.4rem 1.2rem;
            border-radius: 20px;
            font-weight: 600;
            font-family: var(--font-secondary);
        }

        .user-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .user-row:hover {
            background: var(--bg-light);
            border-radius: 12px;
        }

        .user-name {
            font-weight: 600;
            color: var(--primary-navy);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            font-family: var(--font-primary);
        }

        .user-email {
            font-size: 0.8rem;
            color: #718096;
            font-family: var(--font-secondary);
        }

        .admin-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .admin-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.2s;
            font-family: var(--font-secondary);
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .evict-btn { background: var(--danger); color: white; }
        .change-password-btn { background: var(--primary-navy); color: white; }
        .site-password-btn { background: var(--accent-gold); color: var(--primary-navy); }
        .transfer-btn { background: #4a5568; color: white; }

        /* Create Post */
        .create-post {
            background: white;
            margin: 1.5rem;
            padding: 1.5rem;
            border-radius: 24px;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .post-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 1.5rem;
            background: var(--bg-gray);
            padding: 0.5rem;
            border-radius: 40px;
            overflow-x: auto;
        }

        .post-tab {
            flex: 1;
            min-width: 70px;
            padding: 0.8rem;
            background: none;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .post-tab.active {
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .post-input-container {
            margin-bottom: 1.5rem;
        }

        .post-input {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            resize: vertical;
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: all 0.2s;
        }

        .post-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(245,179,66,0.2);
        }

        .mic-button-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .mic-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: none;
            color: var(--primary-navy);
            font-size: 1.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(245,179,66,0.4);
        }

        .mic-button.recording {
            background: var(--danger);
            color: white;
            animation: pulse 1s infinite;
        }

        .recording-timer {
            background: var(--danger);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: bold;
            font-family: var(--font-secondary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .media-btn {
            padding: 0.8rem 1.5rem;
            background: var(--bg-gray);
            border: none;
            border-radius: 30px;
            color: var(--primary-navy);
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .media-btn:hover {
            background: var(--accent-gold);
            color: var(--primary-navy);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(245,179,66,0.3);
        }

        .media-preview {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .preview-item {
            position: relative;
            width: 90px; height: 90px;
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid var(--primary-navy);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .preview-item img, .preview-item video {
            width: 100%; height: 100%;
            object-fit: cover;
        }

        .preview-item audio {
            width: 90px; height: 90px;
        }

        .remove-preview {
            position: absolute;
            top: 5px; right: 5px;
            background: var(--danger);
            color: white;
            border: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .post-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            border: 2px solid var(--accent-gold);
            transition: all 0.3s;
            font-family: var(--font-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .post-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(245,179,66,0.4);
        }

        /* Users Directory */
        #usersDirectory {
            margin: 1.5rem;
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .directory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .directory-header h3 {
            color: var(--primary-navy);
            font-family: var(--font-elegant);
            font-size: 1.5rem;
        }

        .directory-search {
            margin-bottom: 1.5rem;
        }

        .directory-search input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-family: var(--font-primary);
            font-size: 0.95rem;
        }

        .directory-search input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(245,179,66,0.2);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            max-height: 350px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .user-card {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(245,179,66,0.2);
        }

        .user-card-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid var(--accent-gold);
            flex-shrink: 0;
        }

        .user-card-info {
            flex: 1;
            min-width: 0;
        }

        .user-card-name {
            font-weight: 600;
            color: var(--primary-navy);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: var(--font-primary);
        }

        .user-card-grade {
            font-size: 0.75rem;
            color: #718096;
            font-family: var(--font-secondary);
        }

        /* Chat List */
        #chatList {
            margin: 1.5rem;
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: 2px solid var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chat-list-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .chat-list-header h3 {
            color: var(--primary-navy);
            font-family: var(--font-elegant);
            font-size: 1.5rem;
        }

        .chat-items {
            max-height: 350px;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
        }

        .chat-item:hover {
            background: var(--bg-light);
            transform: translateX(5px);
        }

        .chat-item-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border: 2px solid var(--accent-gold);
            flex-shrink: 0;
        }

        .chat-item-info {
            flex: 1;
            min-width: 0;
        }

        .chat-item-name {
            font-weight: 600;
            color: var(--primary-navy);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: var(--font-primary);
        }

        .chat-item-last {
            font-size: 0.85rem;
            color: #718096;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            font-family: var(--font-secondary);
        }

        .chat-item-badge {
            background: var(--danger);
            color: white;
            border-radius: 20px;
            padding: 0.3rem 0.7rem;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
            font-family: var(--font-secondary);
        }

        /* Feed */
        .feed {
            margin: 1.5rem;
        }

        .feed-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
            background: white;
            padding: 0.6rem;
            border-radius: 40px;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .feed-tab {
            flex: 1;
            min-width: 80px;
            padding: 0.8rem;
            background: none;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .feed-tab.active {
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .search-bar {
            margin: 1.5rem 0;
        }

        .search-bar input {
            width: 100%;
            padding: 1.2rem 1.2rem 1.2rem 3.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 40px;
            font-size: 1rem;
            font-family: var(--font-primary);
            transition: all 0.2s;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 4px rgba(245,179,66,0.2);
        }

        .posts-grid {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .post-card {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .post-card:hover {
            box-shadow: 0 8px 25px rgba(245,179,66,0.15);
            transform: translateY(-2px);
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .author-avatar {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.3rem;
            border: 2px solid var(--accent-gold);
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .author-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--accent-gold);
        }

        .author-info {
            flex: 1;
            min-width: 0;
        }

        .author-info h4 {
            font-size: 1.1rem;
            color: var(--primary-navy);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            font-family: var(--font-primary);
            font-weight: 600;
        }

        .timestamp {
            font-size: 0.75rem;
            color: #718096;
            font-family: var(--font-secondary);
        }

        .post-content {
            margin: 1rem 0;
            color: var(--text-dark);
            word-wrap: break-word;
            font-family: var(--font-primary);
            line-height: 1.6;
        }

        .post-actions {
            display: flex;
            gap: 15px;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .action-btn {
            background: none;
            border: none;
            color: #4a5568;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            transition: all 0.2s;
            font-family: var(--font-secondary);
        }

        .action-btn:hover {
            background: var(--bg-gray);
            color: var(--primary-navy);
            transform: translateY(-2px);
        }

        .delete-btn {
            color: var(--danger);
            margin-left: auto;
        }

        .delete-btn:hover {
            background: #fee2e2;
        }

        .class-card {
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            padding: 1.2rem;
            border-radius: 16px;
            text-align: center;
            border: 2px solid var(--accent-gold);
            cursor: pointer;
            transition: all 0.3s;
            font-family: var(--font-secondary);
        }

        .class-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(245,179,66,0.3);
        }

        .class-card.active {
            background: var(--accent-gold);
            color: var(--primary-navy);
            border-color: var(--primary-navy);
        }

        /* Private Chat */
        .chat-container {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 380px;
            max-width: 90%;
            background: white;
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            border: 3px solid var(--accent-gold);
            z-index: 1000;
            display: none;
            flex-direction: column;
            max-height: 550px;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-navy), var(--secondary-navy));
            color: white;
            padding: 1.2rem;
            border-radius: 21px 21px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: var(--font-elegant);
        }

        .chat-close {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chat-close:hover {
            transform: scale(1.2);
            color: white;
        }

        .chat-messages {
            padding: 1.2rem;
            overflow-y: auto;
            max-height: 350px;
            min-height: 250px;
            background: var(--bg-light);
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .chat-message.sent {
            align-items: flex-end;
        }

        .chat-message.received {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 0.8rem 1.2rem;
            border-radius: 20px;
            font-size: 0.95rem;
            word-wrap: break-word;
            font-family: var(--font-primary);
        }

        .sent .message-bubble {
            background: var(--accent-gold);
            color: var(--primary-navy);
            border-bottom-right-radius: 4px;
        }

        .received .message-bubble {
            background: #e2e8f0;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 0.65rem;
            color: #718096;
            margin-top: 0.3rem;
            font-family: var(--font-secondary);
        }

        .chat-input-area {
            display: flex;
            padding: 1.2rem;
            gap: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-family: var(--font-primary);
            transition: all 0.2s;
        }

        .chat-input-area input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245,179,66,0.2);
        }

        .chat-input-area button {
            padding: 0.8rem 1.5rem;
            background: var(--primary-navy);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .chat-input-area button:hover {
            background: var(--secondary-navy);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .app-footer {
            text-align: center;
            padding: 2rem;
            color: #718096;
            background: white;
            margin-top: 2rem;
            border-top: 3px solid var(--accent-gold);
            font-family: var(--font-secondary);
            font-size: 0.9rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 20000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 32px;
            max-width: 450px;
            width: 90%;
            border: 3px solid var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: var(--primary-navy);
            margin-bottom: 1.5rem;
            font-family: var(--font-elegant);
            font-size: 1.5rem;
        }

        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-family: var(--font-primary);
        }

        .modal-content input:focus, .modal-content select:focus, .modal-content textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245,179,66,0.2);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 1.5rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-secondary);
        }

        .modal-confirm { 
            background: var(--primary-navy); 
            color: white; 
        }
        .modal-confirm:hover {
            background: var(--secondary-navy);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .modal-cancel { 
            background: #e2e8f0; 
            color: var(--text-dark); 
        }
        .modal-cancel:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        /* Avatar options in modal */
        .avatar-options {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 1rem 0;
        }

        /* Back button */
        .back-button {
            background: var(--primary-navy);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            margin: 0.5rem 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-secondary);
            transition: all 0.2s;
        }

        .back-button:hover {
            background: var(--secondary-navy);
            transform: translateX(-5px);
        }

        /* Notification badge */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            position: absolute;
            top: -6px;
            right: -6px;
        }

        .chat-tab-container {
            position: relative;
            display: inline-block;
        }

        /* Transfer Modal specific */
        .transfer-info {
            background: var(--bg-light);
            padding: 1.2rem;
            border-radius: 16px;
            margin: 1.2rem 0;
            text-align: center;
            font-family: var(--font-primary);
            border: 2px solid var(--accent-gold);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .auth-card h1 {
                font-size: 2.5rem;
            }
            .school-badge h2 {
                font-size: 1.3rem;
            }
            .slogan-small {
                display: none;
            }
            .post-tab {
                min-width: 60px;
                font-size: 0.8rem;
                padding: 0.6rem 0.3rem;
            }
            .users-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Emoji list for avatars */
        .emoji-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 1rem 0;
            justify-content: center;
        }
        
        .emoji-item {
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
        }
        
        .emoji-item:hover {
            transform: scale(1.2);
            border-color: var(--accent-gold);
        }
        
        .emoji-item.selected {
            border-color: var(--accent-gold);
            background: rgba(245,179,66,0.1);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div style="font-family: 'Playfair Display', serif; font-size: 1.5rem;">CWHSROOM</div>
        <div style="font-family: 'Playfair Display', serif; font-style: italic; color: #f5b342;">God our Foundation</div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none;">
    <input type="file" id="videoInput" accept="video/*" capture="camcorder" style="display:none;">
    <input type="file" id="audioInput" accept="audio/*" capture="microphone" style="display:none;">
    <input type="file" id="fileInput" accept="image/*,video/*,audio/*" style="display:none;" multiple>
    <input type="file" id="avatarUpload" accept="image/*" style="display:none;">

    <!-- Private Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <h3 id="chatWith">Private Chat</h3>
            <button class="chat-close" onclick="closeChat()">√ó</button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="sendChatMessage()">Send</button>
        </div>
    </div>

    <!-- Transfer Title Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <h3 id="transferTitle">Transfer Admin Title</h3>
            <div class="transfer-info" id="transferFromInfo"></div>
            <select id="transferToUser">
                <option value="">Select title to transfer</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeTransferModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmTransfer()">Transfer</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Profile</h3>
            
            <label style="font-weight:600; margin-top:1rem; display:block;">Choose Avatar</label>
            <div class="emoji-list">
                <span class="emoji-item" onclick="selectAvatar('üë§')">üë§</span>
                <span class="emoji-item" onclick="selectAvatar('üë®‚Äçüéì')">üë®‚Äçüéì</span>
                <span class="emoji-item" onclick="selectAvatar('üë©‚Äçüéì')">üë©‚Äçüéì</span>
                <span class="emoji-item" onclick="selectAvatar('üë®‚Äçüè´')">üë®‚Äçüè´</span>
                <span class="emoji-item" onclick="selectAvatar('üë©‚Äçüè´')">üë©‚Äçüè´</span>
                <span class="emoji-item" onclick="selectAvatar('üåü')">üåü</span>
                <span class="emoji-item" onclick="selectAvatar('‚≠ê')">‚≠ê</span>
                <span class="emoji-item" onclick="selectAvatar('üìö')">üìö</span>
                <span class="emoji-item" onclick="selectAvatar('‚úèÔ∏è')">‚úèÔ∏è</span>
                <span class="emoji-item" onclick="selectAvatar('üéì')">üéì</span>
            </div>
            
            <button class="media-btn" style="width:100%; margin:1rem 0;" onclick="uploadAvatar()">üì∑ Upload Photo</button>
            
            <input type="text" id="editName" placeholder="Full Name">
            <select id="editGrade">
                <option value="Grade 8">Grade 8</option>
                <option value="Grade 9">Grade 9</option>
                <option value="Grade 10">Grade 10</option>
                <option value="Grade 11">Grade 11</option>
                <option value="Teacher">Teacher</option>
                <option value="Staff">Staff</option>
            </select>
            <textarea id="editBio" placeholder="Write a short bio..." rows="3"></textarea>
            
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeEditProfileModal()">Cancel</button>
                <button class="modal-confirm" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- View Profile Modal -->
    <div id="viewProfileModal" class="modal">
        <div class="modal-content">
            <h3 id="viewProfileName">User Profile</h3>
            <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem;">
                <div id="viewProfileAvatar" class="profile-avatar-large" style="width:120px; height:120px; font-size:4rem;">üë§</div>
                <h2 id="viewProfileFullName" style="margin-top:1rem; color:var(--primary-navy);"></h2>
                <p id="viewProfileGrade" style="color:var(--accent-gold-dark); font-weight:600;"></p>
            </div>
            
            <div style="background:var(--bg-light); padding:1rem; border-radius:16px; margin-bottom:1rem;">
                <p id="viewProfileBio" style="font-style:italic; color:#4a5568;"></p>
            </div>
            
            <div style="display: flex; justify-content: space-around; margin-bottom:1.5rem;">
                <div style="text-align:center;">
                    <div style="font-weight:700; font-size:1.2rem;" id="viewProfilePosts">0</div>
                    <div style="font-size:0.8rem; color:#718096;">Posts</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-weight:700; font-size:1.2rem;" id="viewProfileJoined">2026</div>
                    <div style="font-size:0.8rem; color:#718096;">Joined</div>
                </div>
            </div>
            
            <button class="post-btn" onclick="startChatFromProfile()">üí¨ Send Message</button>
            <button class="modal-cancel" style="margin-top:1rem;" onclick="closeViewProfileModal()">Close</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>Change User Password</h3>
            <input type="password" id="newPassword" placeholder="New Password">
            <input type="password" id="confirmPassword" placeholder="Confirm">
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closePasswordModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmPasswordChange()">Change</button>
            </div>
        </div>
    </div>

    <div id="sitePasswordModal" class="modal">
        <div class="modal-content">
            <h3>Change School Password</h3>
            <p style="color:#666; margin-bottom:1rem;">Current: <span id="currentSitePassword"></span></p>
            <input type="password" id="newSitePassword" placeholder="New School Password">
            <input type="password" id="confirmSitePassword" placeholder="Confirm">
            <div class="modal-buttons">
                <button class="modal-cancel" onclick="closeSitePasswordModal()">Cancel</button>
                <button class="modal-confirm" onclick="confirmSitePasswordChange()">Change</button>
            </div>
        </div>
    </div>

    <div id="customAlert"></div>

    <!-- SIGN UP -->
    <div id="signupPage">
        <div class="auth-card">
            <h1>üéì CWHSROOM</h1>
            <div class="subtitle">Charles Wesley High School</div>
            <div class="slogan">‚úùÔ∏è God our Foundation</div>
            
            <input type="text" id="signupFullName" placeholder="Full Name">
            
            <select id="signupGrade">
                <option value="">Select Grade / Role</option>
                <option value="Grade 8">Grade 8</option>
                <option value="Grade 9">Grade 9</option>
                <option value="Grade 10">Grade 10</option>
                <option value="Grade 11">Grade 11</option>
                <option value="Teacher">Teacher</option>
                <option value="Staff">Staff</option>
                <option value="Admin" id="adminOption" style="color:#f5b342; font-weight:bold;">üëë Admin (Founder/Principal/Deputy)</option>
            </select>
            
            <!-- Admin Title Selection (hidden by default) -->
            <select id="adminTitle" style="display: none; margin-top:0.5rem;">
                <option value="">Select Admin Title</option>
                <option value="founder">üëë Founder</option>
                <option value="principal">üìö Principal</option>
                <option value="deputy">üìã Deputy</option>
            </select>
            
            <input type="email" id="signupEmail" placeholder="Email">
            <input type="password" id="signupPassword" placeholder="Create Password">
            <input type="password" id="signupConfirm" placeholder="Confirm Password">
            <input type="password" id="signupSchoolPassword" placeholder="School Password">
            <div class="school-password-hint">founded by a young programmer</div>
            
            <button onclick="signup()">CREATE ACCOUNT</button>
            
            <p style="text-align:center">Already have an account? <a onclick="showLogin()">Sign In</a></p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginPage">
        <div class="auth-card">
            <h1>üìö WELCOME BACK</h1>
            <div class="slogan">‚úùÔ∏è God our Foundation</div>
            <input type="text" id="loginUsername" placeholder="Email or Full Name">
            <input type="password" id="loginPassword" placeholder="Your Password">
            <input type="password" id="loginSchoolPassword" placeholder="School Password">
            <div class="school-password-hint">founded by a young programmer</div>
            <button onclick="login()">SIGN IN</button>
            <p style="text-align:center">New here? <a onclick="showSignup()">Create Account</a></p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="top-bar">
            <div class="school-badge">
                <h2>üéì CWHSROOM</h2>
                <div class="slogan-small">God our Foundation</div>
                <button class="refresh-btn" onclick="refreshData()" title="Refresh">üîÑ</button>
            </div>
            <button id="userMenuBtn" onclick="logout()">üë§ Loading...</button>
        </div>

        <!-- Profile Section -->
        <div id="profileSection">
            <div class="profile-header">
                <div class="profile-avatar-large" id="profileAvatar" onclick="openEditProfileModal()">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">Loading...</div>
                    <div class="profile-grade" id="profileGrade"></div>
                    <div class="profile-bio" id="profileBio">Click edit to add a bio</div>
                    <div class="profile-stats">
                        <span id="profilePostCount">0 posts</span>
                        <span id="profileJoined">Joined 2026</span>
                    </div>
                </div>
                <button class="edit-profile-btn" onclick="openEditProfileModal()">‚úèÔ∏è Edit Profile</button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminSection" style="display: none;">
            <div class="admin-header">
                <h3>üëë Admin Panel</h3>
                <div class="admin-stats" id="adminStats">0 users</div>
            </div>
            <div style="margin-bottom:1rem; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="admin-btn site-password-btn" onclick="openSitePasswordModal()">üîê Change School Password</button>
            </div>
            <div class="user-management" id="userList"></div>
        </div>

        <!-- Users Directory -->
        <div id="usersDirectory">
            <div class="directory-header">
                <h3>üë• Users Directory</h3>
                <span style="color:#718096;" id="userCount">0 users</span>
            </div>
            <div class="directory-search">
                <input type="text" id="directorySearch" placeholder="Search users..." onkeyup="renderUserDirectory()">
            </div>
            <div class="users-grid" id="usersGrid"></div>
        </div>

        <!-- Chat List -->
        <div id="chatList">
            <div class="chat-list-header">
                <h3>üí¨ Private Chats</h3>
                <span style="color:#718096;" id="chatCount">0 chats</span>
            </div>
            <div class="chat-items" id="chatItems"></div>
        </div>

        <div class="create-post">
            <div class="post-tabs">
                <button class="post-tab active" onclick="switchPostTab('text')">üìù Text</button>
                <button class="post-tab" onclick="takePhoto()">üì∑ Photo</button>
                <button class="post-tab" onclick="recordVideo()">üé• Video</button>
                <button class="post-tab" onclick="recordAudio()">üéµ Audio</button>
                <button class="post-tab" onclick="switchPostTab('study')">üìñ Study</button>
            </div>
            
            <div class="post-input-container">
                <textarea id="postContent" class="post-input" placeholder="What's on your mind?" rows="2"></textarea>
            </div>

            <div class="mic-button-container">
                <button id="micButton" class="mic-button" 
                        onmousedown="startRecording()" 
                        onmouseup="stopRecording()" 
                        onmouseleave="stopRecording()"
                        ontouchstart="startRecording()" 
                        ontouchend="stopRecording()"
                        ontouchcancel="stopRecording()">üé§</button>
                <div id="recordingTimer" class="recording-timer" style="display: none;">0:00</div>
                <span style="color:#718096;">Press and hold to record voice</span>
            </div>
            
            <div id="studyClassSelector" style="display: none; margin-bottom: 1rem;">
                <select id="studyClass" class="post-input">
                    <option value="">Select class</option>
                    <option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option><option value="8D">8D</option>
                    <option value="9A">9A</option><option value="9B">9B</option><option value="9C">9C</option><option value="9D">9D</option>
                    <option value="10A">10A</option><option value="10B">10B</option><option value="10C">10C</option><option value="10D">10D</option>
                    <option value="11A">11A</option><option value="11B">11B</option><option value="11C">11C</option>
                </select>
            </div>
            
            <div class="media-controls">
                <button class="media-btn" onclick="document.getElementById('fileInput').click()">üìé Add Files</button>
                <span>Max 5 files</span>
            </div>
            <div class="media-preview" id="mediaPreview"></div>
            <button class="post-btn" onclick="createPost()">üì¢ POST</button>
        </div>

        <div class="feed">
            <div class="feed-tabs">
                <button class="feed-tab active" onclick="switchFeed('latest')">üïí Latest</button>
                <button class="feed-tab" onclick="switchFeed('popular')">üî• Popular</button>
                <button class="feed-tab" onclick="switchFeed('mygrade')">üìö My Grade</button>
                <button class="feed-tab" onclick="showStudyHub()">üìñ Study Hub</button>
            </div>
            
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search..." onkeyup="renderFeed()">
            </div>
            
            <!-- Study Hub Class Filter -->
            <div id="classFilterBar" style="display: none; margin: 1rem 0;">
                <button class="back-button" onclick="showAllPosts()">‚Üê Back to all posts</button>
                <div style="background: #0b1e33; color: white; padding: 1rem; border-radius: 12px; margin-top: 0.5rem;">
                    <h3 style="color: #f5b342;">Class: <span id="currentClass"></span></h3>
                    <p id="classPostCount"></p>
                </div>
            </div>
            
            <div id="postsFeed" class="posts-grid"></div>
            
            <div id="studyHubView" style="display: none;">
                <h3 style="color:white; margin:1rem;">Study Hub Classes</h3>
                <div class="classes-grid" id="classesGrid"></div>
            </div>
        </div>

        <div class="app-footer">
            <p>Charles Wesley High School ‚Ä¢ Grade 8-11</p>
            <p style="font-family: 'Playfair Display', serif; font-style: italic; color: #f5b342; margin-top:0.5rem;">"God our Foundation"</p>
            <p style="margin-top:0.5rem;">Created by Lihle Mthembu</p>
        </div>
    </div>

    <script>
        // ==================== CONFIG ====================
        const BIN_ID = '69995ebfd0ea881f40cbca44';
        const API_KEY = '$2a$10$m8uYvFYN61dc8cNoeUnDbuScQ3jPyONR75jfR1hXNT6H8DXV6BwEq';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // ==================== SCHOOL PASSWORD ====================
        let SCHOOL_PASSWORD = 'CWHS123';

        // ==================== ADMIN TITLES ====================
        let adminTitles = {
            founder: null,
            principal: null,
            deputy: null
        };

        // Allowed email domains
        const ALLOWED_DOMAINS = ['gmail.com', 'yahoo.com', 'outlook.com', 'icloud.com'];

        // Study classes
        const STUDY_CLASSES = ['8A','8B','8C','8D','9A','9B','9C','9D','10A','10B','10C','10D','11A','11B','11C'];

        // Avatar emojis
        const AVATAR_EMOJIS = ['üë§', 'üë®‚Äçüéì', 'üë©‚Äçüéì', 'üë®‚Äçüè´', 'üë©‚Äçüè´', 'üåü', '‚≠ê', 'üìö', '‚úèÔ∏è', 'üéì'];

        // ==================== GLOBAL DATA ====================
        let currentUser = null;
        let posts = [];
        let users = [];
        let currentFeed = 'latest';
        let mediaFiles = [];
        let selectedUserId = null;
        let activePostForComment = null;
        let currentClassFilter = null;
        let privateMessages = [];
        let currentChatPartner = null;
        let transferData = null;
        let selectedAvatar = 'üë§';

        // Voice recording
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let isRecording = false;

        // ==================== HELPERS ====================
        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function showAlert(msg, type = 'success') {
            const alertDiv = document.getElementById('customAlert');
            alertDiv.innerHTML = `
                <div class="alert-content alert-${type}">
                    <span class="alert-icon">${type === 'success' ? '‚úì' : '‚úï'}</span>
                    <span class="alert-message">${msg}</span>
                </div>
            `;
            alertDiv.style.display = 'block';
            setTimeout(() => { alertDiv.style.display = 'none'; }, 3000);
        }

        function isAdmin(user) {
            return user && (user.adminTitle === 'founder' || user.adminTitle === 'principal' || user.adminTitle === 'deputy');
        }

        function getAdminBadgeClass(title) {
            switch(title) {
                case 'founder': return 'admin-badge-founder';
                case 'principal': return 'admin-badge-principal';
                case 'deputy': return 'admin-badge-deputy';
                default: return '';
            }
        }

        function getAdminTitleDisplay(title) {
            switch(title) {
                case 'founder': return 'üëë Founder';
                case 'principal': return 'üìö Principal';
                case 'deputy': return 'üìã Deputy';
                default: return '';
            }
        }

        function isValidEmail(email) {
            if (!email || !email.includes('@')) return false;
            const domain = email.split('@')[1].toLowerCase();
            return ALLOWED_DOMAINS.includes(domain);
        }

        // ==================== PROFILE FUNCTIONS ====================
        function updateProfileDisplay() {
            if (!currentUser) return;
            
            document.getElementById('profileAvatar').innerText = currentUser.avatar || 'üë§';
            document.getElementById('profileName').innerText = currentUser.name;
            document.getElementById('profileGrade').innerText = currentUser.grade;
            document.getElementById('profileBio').innerText = currentUser.bio || 'No bio yet';
            
            const userPosts = posts.filter(p => p.userId === currentUser.id).length;
            document.getElementById('profilePostCount').innerText = `${userPosts} posts`;
            
            const joinDate = new Date(currentUser.joined).getFullYear();
            document.getElementById('profileJoined').innerText = `Joined ${joinDate}`;
        }

        function openEditProfileModal() {
            if (!currentUser) return;
            
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editGrade').value = currentUser.grade;
            document.getElementById('editBio').value = currentUser.bio || '';
            selectedAvatar = currentUser.avatar || 'üë§';
            
            // Highlight selected avatar
            document.querySelectorAll('.emoji-item').forEach(el => {
                if (el.innerText === selectedAvatar) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
            
            document.getElementById('editProfileModal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').style.display = 'none';
        }

        function selectAvatar(emoji) {
            selectedAvatar = emoji;
            document.querySelectorAll('.emoji-item').forEach(el => {
                if (el.innerText === emoji) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        function uploadAvatar() {
            document.getElementById('avatarUpload').click();
        }

        document.getElementById('avatarUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedAvatar = e.target.result;
                    // You can't preview image in emoji list, but will be saved
                    showAlert('Image selected! Save profile to apply.', 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        async function saveProfile() {
            if (!currentUser) return;
            
            const newName = document.getElementById('editName').value.trim();
            const newGrade = document.getElementById('editGrade').value;
            const newBio = document.getElementById('editBio').value.trim();
            
            if (!newName || !newGrade) {
                showAlert('Name and grade required', 'error');
                return;
            }
            
            // Update user
            currentUser.name = newName;
            currentUser.grade = newGrade;
            currentUser.bio = newBio;
            currentUser.avatar = selectedAvatar;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
            }
            
            // Update in posts
            posts.forEach(p => {
                if (p.userId === currentUser.id) {
                    p.author = newName;
                    p.avatar = selectedAvatar;
                    p.grade = newGrade;
                }
            });
            
            await saveData();
            
            updateProfileDisplay();
            document.getElementById('userMenuBtn').innerText = `üë§ ${newName.split(' ')[0]}`;
            renderFeed();
            renderUserDirectory();
            renderChatList();
            
            closeEditProfileModal();
            showAlert('Profile updated!', 'success');
        }

        function viewProfile(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('viewProfileName').innerText = `${user.name}'s Profile`;
            document.getElementById('viewProfileAvatar').innerText = user.avatar || 'üë§';
            document.getElementById('viewProfileFullName').innerText = user.name;
            document.getElementById('viewProfileGrade').innerText = user.grade;
            document.getElementById('viewProfileBio').innerText = user.bio || 'No bio yet';
            
            const userPosts = posts.filter(p => p.userId === userId).length;
            document.getElementById('viewProfilePosts').innerText = userPosts;
            
            const joinYear = new Date(user.joined).getFullYear();
            document.getElementById('viewProfileJoined').innerText = joinYear;
            
            // Store for chat
            window.profileViewUserId = userId;
            window.profileViewUserName = user.name;
            
            document.getElementById('viewProfileModal').style.display = 'flex';
        }

        function closeViewProfileModal() {
            document.getElementById('viewProfileModal').style.display = 'none';
        }

        function startChatFromProfile() {
            closeViewProfileModal();
            if (window.profileViewUserId) {
                openChat(window.profileViewUserId, window.profileViewUserName);
            }
        }

        // ==================== ADMIN TITLE MANAGEMENT ====================
        function updateAdminTitles() {
            adminTitles = {
                founder: null,
                principal: null,
                deputy: null
            };
            
            users.forEach(user => {
                if (user.adminTitle) {
                    adminTitles[user.adminTitle] = user.id;
                }
            });
            
            // Update admin option in signup
            const adminOption = document.getElementById('adminOption');
            if (adminOption) {
                const availableTitles = [];
                if (!adminTitles.founder) availableTitles.push('Founder');
                if (!adminTitles.principal) availableTitles.push('Principal');
                if (!adminTitles.deputy) availableTitles.push('Deputy');
                
                if (availableTitles.length === 0) {
                    adminOption.disabled = true;
                    adminOption.textContent = 'üëë Admin (No titles available)';
                } else {
                    adminOption.disabled = false;
                    adminOption.textContent = `üëë Admin (Available: ${availableTitles.join(', ')})`;
                }
            }
        }

        // Show/hide admin title select based on grade selection
        document.getElementById('signupGrade').addEventListener('change', function() {
            const adminTitleSelect = document.getElementById('adminTitle');
            if (this.value === 'Admin') {
                adminTitleSelect.style.display = 'block';
                
                // Update available options based on current adminTitles
                const options = adminTitleSelect.querySelectorAll('option');
                options.forEach(opt => {
                    if (opt.value) {
                        if (adminTitles[opt.value]) {
                            opt.disabled = true;
                            opt.textContent = `${getAdminTitleDisplay(opt.value)} (Already taken)`;
                        } else {
                            opt.disabled = false;
                            opt.textContent = getAdminTitleDisplay(opt.value);
                        }
                    }
                });
            } else {
                adminTitleSelect.style.display = 'none';
            }
        });

        // ==================== REFRESH BUTTON ====================
        async function refreshData() {
            showAlert('Refreshing...', 'success');
            await loadData();
            updateProfileDisplay();
            if (currentClassFilter) {
                filterByClass(currentClassFilter);
            } else {
                renderFeed();
            }
            renderUserDirectory();
            renderChatList();
            renderUserList();
            showAlert('Refreshed!', 'success');
        }

        // ==================== USER DIRECTORY ====================
        function renderUserDirectory() {
            const grid = document.getElementById('usersGrid');
            const search = document.getElementById('directorySearch')?.value.toLowerCase() || '';
            
            let filteredUsers = users.filter(u => u.id !== currentUser?.id);
            
            if (search) {
                filteredUsers = filteredUsers.filter(u => 
                    u.name.toLowerCase().includes(search) ||
                    u.grade.toLowerCase().includes(search) ||
                    (u.adminTitle && u.adminTitle.toLowerCase().includes(search))
                );
            }
            
            document.getElementById('userCount').innerText = `${filteredUsers.length} users`;
            
            let html = '';
            filteredUsers.forEach(user => {
                const adminBadge = user.adminTitle ? 
                    `<span class="${getAdminBadgeClass(user.adminTitle)}">${getAdminTitleDisplay(user.adminTitle)}</span>` : '';
                
                html += `
                    <div class="user-card" onclick="viewProfile('${user.id}')">
                        <div class="user-card-avatar">${user.avatar || 'üë§'}</div>
                        <div class="user-card-info">
                            <div class="user-card-name">${user.name} ${adminBadge}</div>
                            <div class="user-card-grade">${user.grade}</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html || '<p style="padding:1rem; text-align:center;">No users found</p>';
        }

        // ==================== CHAT LIST ====================
        function renderChatList() {
            const chatItems = document.getElementById('chatItems');
            
            if (!currentUser) return;
            
            const chatPartners = new Set();
            const userMessages = privateMessages.filter(m => 
                m.senderId === currentUser.id || m.receiverId === currentUser.id
            );
            
            userMessages.forEach(m => {
                const partnerId = m.senderId === currentUser.id ? m.receiverId : m.senderId;
                chatPartners.add(partnerId);
            });
            
            document.getElementById('chatCount').innerText = `${chatPartners.size} chats`;
            
            if (chatPartners.size === 0) {
                chatItems.innerHTML = '<p style="padding:1rem; text-align:center;">No chats yet</p>';
                return;
            }
            
            let html = '';
            chatPartners.forEach(partnerId => {
                const partner = users.find(u => u.id === partnerId);
                if (!partner) return;
                
                const chatId = getChatId(currentUser.id, partnerId);
                const messages = privateMessages.filter(m => m.chatId === chatId);
                const lastMessage = messages[messages.length - 1];
                
                const unreadCount = messages.filter(m => 
                    m.receiverId === currentUser.id && !m.read
                ).length;
                
                const adminBadge = partner.adminTitle ? 
                    `<span class="${getAdminBadgeClass(partner.adminTitle)}" style="margin-left:0.3rem;">${partner.adminTitle.charAt(0).toUpperCase()}</span>` : '';
                
                html += `
                    <div class="chat-item" onclick="openChat('${partnerId}', '${partner.name}')">
                        <div class="chat-item-avatar">${partner.avatar || 'üë§'}</div>
                        <div class="chat-item-info">
                            <div class="chat-item-name">${partner.name} ${adminBadge}</div>
                            <div class="chat-item-last">${lastMessage ? lastMessage.text : 'No messages'}</div>
                        </div>
                        ${unreadCount > 0 ? `<div class="chat-item-badge">${unreadCount}</div>` : ''}
                    </div>
                `;
            });
            
            chatItems.innerHTML = html;
        }

        // ==================== PRIVATE CHAT FUNCTIONS ====================
        function openChat(userId, userName) {
            if (!currentUser) {
                showAlert('Please login first', 'error');
                return;
            }
            
            if (userId === currentUser.id) {
                showAlert('You cannot chat with yourself', 'error');
                return;
            }
            
            currentChatPartner = { id: userId, name: userName };
            document.getElementById('chatWith').innerText = `Chat with ${userName}`;
            document.getElementById('chatContainer').style.display = 'flex';
            loadChatMessages();
            
            markMessagesAsRead(userId);
        }

        function closeChat() {
            document.getElementById('chatContainer').style.display = 'none';
            currentChatPartner = null;
            renderChatList();
        }

        function markMessagesAsRead(partnerId) {
            if (!currentUser) return;
            
            const chatId = getChatId(currentUser.id, partnerId);
            let changed = false;
            privateMessages.forEach(m => {
                if (m.chatId === chatId && m.receiverId === currentUser.id && !m.read) {
                    m.read = true;
                    changed = true;
                }
            });
            if (changed) {
                saveData();
                renderChatList();
            }
        }

        function loadChatMessages() {
            if (!currentChatPartner || !currentUser) return;
            
            const chatId = getChatId(currentUser.id, currentChatPartner.id);
            const messages = privateMessages.filter(m => m.chatId === chatId);
            
            const chatDiv = document.getElementById('chatMessages');
            chatDiv.innerHTML = '';
            
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                .forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${msg.senderId === currentUser.id ? 'sent' : 'received'}`;
                    messageDiv.innerHTML = `
                        <div class="message-bubble">${msg.text}</div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                    `;
                    chatDiv.appendChild(messageDiv);
                });
            
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        async function sendChatMessage() {
            if (!currentUser || !currentChatPartner) return;
            
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const chatId = getChatId(currentUser.id, currentChatPartner.id);
            
            const message = {
                id: 'msg_' + Date.now(),
                chatId: chatId,
                senderId: currentUser.id,
                senderName: currentUser.name,
                receiverId: currentChatPartner.id,
                text: text,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            privateMessages.push(message);
            input.value = '';
            
            await saveData();
            
            loadChatMessages();
            renderChatList();
        }

        // ==================== VOICE RECORDING FUNCTIONS ====================
        async function startRecording() {
            if (isRecording) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (mediaFiles.length < 5) {
                            mediaFiles.push({
                                type: 'audio',
                                url: e.target.result
                            });
                            updateMediaPreview();
                        } else {
                            showAlert('Max 5 files reached', 'error');
                        }
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('micButton').classList.add('recording');
                document.getElementById('recordingTimer').style.display = 'inline-block';
                
                recordingSeconds = 0;
                updateRecordingTimer();
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateRecordingTimer();
                }, 1000);
                
            } catch (err) {
                showAlert('Microphone access denied', 'error');
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            mediaRecorder.stop();
            isRecording = false;
            
            clearInterval(recordingTimer);
            
            document.getElementById('micButton').classList.remove('recording');
            document.getElementById('recordingTimer').style.display = 'none';
        }

        function updateRecordingTimer() {
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            document.getElementById('recordingTimer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==================== DATABASE ====================
        async function loadData() {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', API_URL, true);
                xhr.setRequestHeader('X-Master-Key', API_KEY);
                xhr.timeout = 10000;
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data && data.record) {
                                users = data.record.users || [];
                                posts = data.record.posts || [];
                                privateMessages = data.record.privateMessages || [];
                                SCHOOL_PASSWORD = data.record.schoolPassword || 'CWHS123';
                                updateAdminTitles();
                            }
                        } catch (e) {
                            console.log('Parse error:', e);
                        }
                    }
                    resolve();
                };
                
                xhr.onerror = function() {
                    console.log('Network error - using local data');
                    resolve();
                };
                
                xhr.ontimeout = function() {
                    console.log('Timeout - using local data');
                    resolve();
                };
                
                xhr.send();
            });
        }

        async function saveData() {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('PUT', API_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('X-Master-Key', API_KEY);
                xhr.timeout = 10000;
                
                xhr.onload = function() {
                    resolve(xhr.status === 200);
                };
                
                xhr.onerror = function() {
                    console.log('Save network error');
                    resolve(false);
                };
                
                xhr.ontimeout = function() {
                    console.log('Save timeout');
                    resolve(false);
                };
                
                xhr.send(JSON.stringify({ 
                    users: users, 
                    posts: posts,
                    privateMessages: privateMessages,
                    schoolPassword: SCHOOL_PASSWORD 
                }));
            });
        }

        // ==================== AUTH ====================
        async function signup() {
            const name = document.getElementById('signupFullName').value.trim();
            const grade = document.getElementById('signupGrade').value;
            const adminTitle = document.getElementById('adminTitle').value;
            const email = document.getElementById('signupEmail').value.trim();
            const pass = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirm').value;
            const schoolPass = document.getElementById('signupSchoolPassword').value;

            if (!name || !grade || !email || !pass || !confirm || !schoolPass) {
                showAlert('Fill all fields', 'error');
                return;
            }

            if (pass !== confirm) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            if (pass.length < 6) {
                showAlert('Password too short', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showAlert('Invalid email domain', 'error');
                return;
            }

            await loadData();
            
            if (schoolPass !== SCHOOL_PASSWORD) {
                showAlert('Incorrect school password', 'error');
                return;
            }

            if (users.find(u => u.email === email)) {
                showAlert('Email exists', 'error');
                return;
            }

            // Check if trying to take an admin title that's already taken
            if (grade === 'Admin') {
                if (!adminTitle) {
                    showAlert('Please select an admin title', 'error');
                    return;
                }
                if (adminTitles[adminTitle]) {
                    showAlert(`The ${adminTitle} title is already taken`, 'error');
                    return;
                }
            }

            const newUser = {
                id: 'user_' + Date.now(),
                name: name,
                grade: grade === 'Admin' ? getAdminTitleDisplay(adminTitle) : grade,
                email: email,
                password: btoa(pass),
                avatar: 'üë§',
                bio: '',
                joined: new Date().toISOString(),
                adminTitle: grade === 'Admin' ? adminTitle : null
            };

            users.push(newUser);
            const saved = await saveData();

            if (saved) {
                currentUser = newUser;
                localStorage.setItem('cwhs_user', newUser.id);
                document.getElementById('userMenuBtn').innerText = `üë§ ${name.split(' ')[0]}`;
                updateAdminTitles();
                showMainApp();
                updateProfileDisplay();
                renderFeed();
                renderUserDirectory();
                renderChatList();
                showAlert(`Welcome ${name}!`);
            } else {
                showAlert('Signup failed - offline mode', 'error');
                currentUser = newUser;
                localStorage.setItem('cwhs_user', newUser.id);
                document.getElementById('userMenuBtn').innerText = `üë§ ${name.split(' ')[0]}`;
                updateAdminTitles();
                showMainApp();
                updateProfileDisplay();
                renderFeed();
                renderUserDirectory();
                renderChatList();
            }
        }

        async function login() {
            const input = document.getElementById('loginUsername').value.trim();
            const pass = document.getElementById('loginPassword').value;
            const schoolPass = document.getElementById('loginSchoolPassword').value;

            if (!input || !pass || !schoolPass) {
                showAlert('Fill all fields', 'error');
                return;
            }

            await loadData();

            if (schoolPass !== SCHOOL_PASSWORD) {
                showAlert('Incorrect school password', 'error');
                return;
            }

            const user = users.find(u => 
                (u.email === input || u.name === input) && 
                u.password === btoa(pass)
            );

            if (!user) {
                showAlert('Invalid credentials', 'error');
                return;
            }

            currentUser = user;
            localStorage.setItem('cwhs_user', user.id);
            document.getElementById('userMenuBtn').innerText = `üë§ ${user.name.split(' ')[0]}`;
            updateAdminTitles();
            showMainApp();
            updateProfileDisplay();
            renderFeed();
            renderUserDirectory();
            renderChatList();
            showAlert(`Welcome back ${user.name}!`);
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('cwhs_user');
            showSignup();
            closeChat();
        }

        async function checkSavedUser() {
            await loadData();
            const savedId = localStorage.getItem('cwhs_user');
            if (savedId) {
                const user = users.find(u => u.id === savedId);
                if (user) {
                    currentUser = user;
                    document.getElementById('userMenuBtn').innerText = `üë§ ${user.name.split(' ')[0]}`;
                    updateAdminTitles();
                    showMainApp();
                    updateProfileDisplay();
                    renderFeed();
                    renderUserDirectory();
                    renderChatList();
                } else {
                    showSignup();
                }
            } else {
                showSignup();
            }
        }

        // ==================== PAGE SWITCH ====================
        function showSignup() {
            document.getElementById('signupPage').style.display = 'flex';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            if (currentUser && isAdmin(currentUser)) {
                document.getElementById('adminSection').style.display = 'block';
                renderUserList();
            } else {
                document.getElementById('adminSection').style.display = 'none';
            }
        }

        // ==================== ADMIN FUNCTIONS ====================
        function renderUserList() {
            const userList = document.getElementById('userList');
            document.getElementById('adminStats').innerText = `${users.length} users`;
            
            let html = '';
            users.forEach(user => {
                const userAdminBadge = user.adminTitle ? 
                    `<span class="${getAdminBadgeClass(user.adminTitle)}">${getAdminTitleDisplay(user.adminTitle)}</span>` : '';
                
                html += `
                    <div class="user-row">
                        <div>
                            <div class="user-name">${user.name} ${userAdminBadge}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                        <div class="admin-actions">
                            ${isAdmin(currentUser) && currentUser.id !== user.id ? `
                                <button class="admin-btn change-password-btn" onclick="openPasswordModal('${user.id}')">Change PW</button>
                                ${!user.adminTitle ? `
                                    <button class="admin-btn evict-btn" onclick="evictUser('${user.id}')">Evict</button>
                                ` : ''}
                                ${currentUser.adminTitle === 'founder' && !user.adminTitle ? `
                                    <button class="admin-btn transfer-btn" onclick="openTransferModal('${user.id}', '${user.name}')">Transfer Title</button>
                                ` : ''}
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            userList.innerHTML = html || '<p style="padding:1rem;">No users</p>';
        }

        function openTransferModal(userId, userName) {
            transferData = { userId, userName };
            
            document.getElementById('transferFromInfo').innerHTML = 
                `Transfer <strong>${currentUser.adminTitle}</strong> title from <strong>${currentUser.name}</strong> to <strong>${userName}</strong>?`;
            
            const select = document.getElementById('transferToUser');
            select.innerHTML = '<option value="">Select title to transfer</option>';
            
            // Add available titles (only the ones this admin has)
            if (currentUser.adminTitle === 'founder') {
                select.innerHTML += `
                    <option value="founder">üëë Founder</option>
                    <option value="principal">üìö Principal</option>
                    <option value="deputy">üìã Deputy</option>
                `;
            }
            
            document.getElementById('transferModal').style.display = 'flex';
        }

        function closeTransferModal() {
            document.getElementById('transferModal').style.display = 'none';
            transferData = null;
        }

        async function confirmTransfer() {
            const titleToTransfer = document.getElementById('transferToUser').value;
            
            if (!titleToTransfer) {
                showAlert('Please select a title to transfer', 'error');
                return;
            }
            
            if (!transferData) return;
            
            const targetUser = users.find(u => u.id === transferData.userId);
            if (!targetUser) return;
            
            // Remove title from current user
            currentUser.adminTitle = null;
            currentUser.grade = 'Former Admin';
            
            // Give title to target user
            targetUser.adminTitle = titleToTransfer;
            targetUser.grade = getAdminTitleDisplay(titleToTransfer);
            
            await saveData();
            updateAdminTitles();
            
            showAlert(`Successfully transferred ${titleToTransfer} title to ${targetUser.name}`, 'success');
            closeTransferModal();
            
            // Refresh displays
            renderUserList();
            renderUserDirectory();
            renderFeed();
            updateProfileDisplay();
            
            // Update current user display
            document.getElementById('userMenuBtn').innerText = `üë§ ${currentUser.name.split(' ')[0]}`;
        }

        function openPasswordModal(userId) {
            selectedUserId = userId;
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            selectedUserId = null;
        }

        async function confirmPasswordChange() {
            if (!selectedUserId || !currentUser) return;
            
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (!newPass || newPass.length < 6) {
                showAlert('Password too short', 'error');
                return;
            }
            
            if (newPass !== confirm) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            const user = users.find(u => u.id === selectedUserId);
            if (user) {
                user.password = btoa(newPass);
                await saveData();
                showAlert(`Password changed for ${user.name}`, 'success');
                closePasswordModal();
            }
        }

        async function evictUser(userId) {
            if (!currentUser) return;
            
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (user.adminTitle) {
                showAlert('Cannot evict an admin', 'error');
                return;
            }
            
            if (confirm(`Evict ${user.name}?`)) {
                users = users.filter(u => u.id !== userId);
                posts = posts.filter(p => p.userId !== userId);
                privateMessages = privateMessages.filter(m => m.senderId !== userId && m.receiverId !== userId);
                await saveData();
                renderUserList();
                renderFeed();
                renderUserDirectory();
                renderChatList();
                showAlert(`${user.name} evicted`, 'success');
            }
        }

        function openSitePasswordModal() {
            document.getElementById('currentSitePassword').innerText = SCHOOL_PASSWORD;
            document.getElementById('sitePasswordModal').style.display = 'flex';
        }

        function closeSitePasswordModal() {
            document.getElementById('sitePasswordModal').style.display = 'none';
            document.getElementById('newSitePassword').value = '';
            document.getElementById('confirmSitePassword').value = '';
        }

        async function confirmSitePasswordChange() {
            const newPass = document.getElementById('newSitePassword').value;
            const confirm = document.getElementById('confirmSitePassword').value;
            
            if (!newPass || newPass.length < 6) {
                showAlert('Password too short', 'error');
                return;
            }
            
            if (newPass !== confirm) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            SCHOOL_PASSWORD = newPass;
            await saveData();
            showAlert('School password changed!', 'success');
            closeSitePasswordModal();
        }

        // ==================== MEDIA ====================
        function takePhoto() {
            const input = document.getElementById('photoInput');
            input.onchange = function() {
                handleMediaCapture(this.files, 'image');
            };
            input.click();
        }

        function recordVideo() {
            const input = document.getElementById('videoInput');
            input.onchange = function() {
                handleMediaCapture(this.files, 'video');
            };
            input.click();
        }

        function recordAudio() {
            const input = document.getElementById('audioInput');
            input.onchange = function() {
                handleMediaCapture(this.files, 'audio');
            };
            input.click();
        }

        function handleMediaCapture(files, type) {
            if (!files || files.length === 0) return;
            if (mediaFiles.length + files.length > 5) {
                showAlert('Max 5 files', 'error');
                return;
            }
            
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    mediaFiles.push({
                        type: type,
                        url: e.target.result
                    });
                    updateMediaPreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function updateMediaPreview() {
            const preview = document.getElementById('mediaPreview');
            preview.innerHTML = '';
            mediaFiles.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                if (f.type === 'image') div.innerHTML = `<img src="${f.url}">`;
                else if (f.type === 'video') div.innerHTML = `<video src="${f.url}"></video>`;
                else if (f.type === 'audio') {
                    div.innerHTML = `<audio src="${f.url}" controls></audio>`;
                    div.style.width = '160px';
                    div.style.height = '40px';
                }
                
                const btn = document.createElement('button');
                btn.className = 'remove-preview';
                btn.innerText = '‚úï';
                btn.onclick = () => {
                    mediaFiles.splice(i, 1);
                    updateMediaPreview();
                };
                div.appendChild(btn);
                preview.appendChild(div);
            });
        }

        function switchPostTab(tab) {
            document.querySelectorAll('.post-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('studyClassSelector').style.display = 
                tab === 'study' ? 'block' : 'none';
        }

        // ==================== POSTS ====================
        async function createPost() {
            if (!currentUser) {
                showLogin();
                return;
            }

            const content = document.getElementById('postContent').value.trim();
            if (!content && mediaFiles.length === 0) {
                showAlert('Add content or media', 'error');
                return;
            }

            const isStudy = document.querySelector('.post-tab.active').innerText.includes('Study');
            let studyClass = '';
            
            if (isStudy) {
                studyClass = document.getElementById('studyClass').value;
                if (!studyClass) {
                    showAlert('Select a class', 'error');
                    return;
                }
            }

            const post = {
                id: 'post_' + Date.now(),
                userId: currentUser.id,
                author: currentUser.name,
                grade: currentUser.grade,
                avatar: currentUser.avatar,
                content: content,
                media: JSON.stringify(mediaFiles),
                timestamp: new Date().toISOString(),
                likes: 0,
                likedBy: [],
                comments: [],
                type: isStudy ? 'study' : 'general',
                studyClass: studyClass,
                authorAdminTitle: currentUser.adminTitle
            };

            posts.unshift(post);
            const saved = await saveData();

            if (saved) {
                document.getElementById('postContent').value = '';
                mediaFiles = [];
                updateMediaPreview();
                document.getElementById('studyClass').value = '';
                
                if (currentClassFilter) {
                    filterByClass(currentClassFilter);
                } else {
                    renderFeed();
                }
                updateProfileDisplay();
                showAlert('Posted!');
            } else {
                document.getElementById('postContent').value = '';
                mediaFiles = [];
                updateMediaPreview();
                document.getElementById('studyClass').value = '';
                
                if (currentClassFilter) {
                    filterByClass(currentClassFilter);
                } else {
                    renderFeed();
                }
                updateProfileDisplay();
                showAlert('Posted (offline mode)', 'success');
            }
        }

        async function deletePost(postId) {
            if (!currentUser) return;

            const post = posts.find(p => p.id === postId);
            if (!post || (post.userId !== currentUser.id && !isAdmin(currentUser))) {
                showAlert('Not authorized', 'error');
                return;
            }

            if (confirm('Delete this post?')) {
                posts = posts.filter(p => p.id !== postId);
                await saveData();
                
                if (currentClassFilter) {
                    filterByClass(currentClassFilter);
                } else {
                    renderFeed();
                }
                updateProfileDisplay();
                showAlert('Deleted');
            }
        }

        async function likePost(postId) {
            if (!currentUser) return;

            const post = posts.find(p => p.id === postId);
            if (!post) return;

            if (!post.likedBy) post.likedBy = [];

            if (post.likedBy.includes(currentUser.id)) {
                post.likes--;
                post.likedBy = post.likedBy.filter(id => id !== currentUser.id);
            } else {
                post.likes++;
                post.likedBy.push(currentUser.id);
            }

            await saveData();
            
            if (currentClassFilter) {
                filterByClass(currentClassFilter);
            } else {
                renderFeed();
            }
        }

        function toggleCommentBox(postId) {
            activePostForComment = activePostForComment === postId ? null : postId;
            
            if (currentClassFilter) {
                filterByClass(currentClassFilter);
            } else {
                renderFeed();
            }
        }

        async function addComment(postId) {
            if (!currentUser) return;
            
            const input = document.getElementById(`comment-input-${postId}`);
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;
            
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            if (!post.comments) post.comments = [];
            
            post.comments.push({
                id: 'c_' + Date.now(),
                userId: currentUser.id,
                author: currentUser.name,
                text: text,
                timestamp: new Date().toISOString()
            });
            
            await saveData();
            activePostForComment = null;
            
            if (currentClassFilter) {
                filterByClass(currentClassFilter);
            } else {
                renderFeed();
            }
        }

        // ==================== STUDY HUB FUNCTIONS ====================
        function showStudyHub() {
            document.getElementById('postsFeed').style.display = 'none';
            document.getElementById('studyHubView').style.display = 'block';
            document.getElementById('classFilterBar').style.display = 'none';
            currentClassFilter = null;
            
            let html = '<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:0.5rem; padding:1rem;">';
            STUDY_CLASSES.forEach(c => {
                const count = posts.filter(p => p.studyClass === c).length;
                html += `<div class="class-card" onclick="filterByClass('${c}')">
                    <h4>${c}</h4>
                    <p>${count} posts</p>
                </div>`;
            });
            html += '</div>';
            document.getElementById('classesGrid').innerHTML = html;
        }

        function filterByClass(className) {
            currentClassFilter = className;
            document.getElementById('postsFeed').style.display = 'block';
            document.getElementById('studyHubView').style.display = 'none';
            document.getElementById('classFilterBar').style.display = 'block';
            document.getElementById('currentClass').innerText = className;
            
            const classPosts = posts.filter(p => p.studyClass === className);
            document.getElementById('classPostCount').innerText = `${classPosts.length} posts in this class`;
            
            renderFeed();
        }

        function showAllPosts() {
            currentClassFilter = null;
            document.getElementById('classFilterBar').style.display = 'none';
            renderFeed();
        }

        // ==================== RENDER ====================
        function renderFeed() {
            const feed = document.getElementById('postsFeed');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = [...posts];

            if (currentClassFilter) {
                filtered = filtered.filter(p => p.studyClass === currentClassFilter);
            }

            if (search) {
                filtered = filtered.filter(p => 
                    (p.content && p.content.toLowerCase().includes(search)) ||
                    (p.author && p.author.toLowerCase().includes(search)) ||
                    (p.studyClass && p.studyClass.toLowerCase().includes(search))
                );
            }

            if (currentFeed === 'latest') {
                filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else if (currentFeed === 'popular') {
                filtered.sort((a,b) => (b.likes||0) - (a.likes||0));
            } else if (currentFeed === 'mygrade' && currentUser) {
                filtered = filtered.filter(p => p.grade === currentUser.grade);
            }

            if (!filtered.length) {
                feed.innerHTML = '<div style="background:white; padding:2rem; text-align:center;">No posts</div>';
                return;
            }

            let html = '';
            filtered.forEach(p => {
                const isOwner = currentUser && (currentUser.id === p.userId || isAdmin(currentUser));
                const liked = currentUser && p.likedBy && p.likedBy.includes(currentUser.id);
                const time = new Date(p.timestamp).toLocaleString();
                
                let mediaHtml = '';
                if (p.media && p.media !== '[]') {
                    try {
                        const media = JSON.parse(p.media);
                        if (media.length) {
                            mediaHtml = '<div style="margin:1rem 0;">';
                            media.forEach(m => {
                                if (m.type === 'image') mediaHtml += `<img src="${m.url}" style="width:100%; border-radius:12px;">`;
                                else if (m.type === 'video') mediaHtml += `<video src="${m.url}" controls style="width:100%; border-radius:12px;"></video>`;
                                else if (m.type === 'audio') mediaHtml += `<audio src="${m.url}" controls style="width:100%;"></audio>`;
                            });
                            mediaHtml += '</div>';
                        }
                    } catch(e) {}
                }

                let commentsHtml = '';
                if (p.comments && p.comments.length) {
                    commentsHtml = '<div style="margin:0.5rem 0;">';
                    p.comments.slice(-3).forEach(c => {
                        commentsHtml += `<div style="padding:0.3rem; background:#f8fafc; margin:0.2rem 0; border-radius:8px;">
                            <strong>${c.author}:</strong> ${c.text}
                        </div>`;
                    });
                    commentsHtml += '</div>';
                }

                const classBadge = p.studyClass ? `<span style="background:#0b1e33; color:#f5b342; padding:0.2rem 0.5rem; border-radius:12px; font-size:0.7rem; margin-left:0.5rem;">${p.studyClass}</span>` : '';
                
                const adminBadge = p.authorAdminTitle ? 
                    `<span class="${getAdminBadgeClass(p.authorAdminTitle)}" style="margin-left:0.3rem;">${getAdminTitleDisplay(p.authorAdminTitle)}</span>` : '';

                html += `
                    <div class="post-card">
                        <div class="post-author" onclick="viewProfile('${p.userId}')">
                            <div class="author-avatar">${p.avatar || 'üë§'}</div>
                            <div class="author-info">
                                <h4>${p.author} ${adminBadge} ${classBadge}</h4>
                                <div class="timestamp">${time}</div>
                            </div>
                        </div>
                        <div class="post-content">${p.content}</div>
                        ${mediaHtml}
                        ${commentsHtml}
                        <div class="post-actions">
                            <button class="action-btn" onclick="likePost('${p.id}')">
                                <span>${liked ? '‚ù§Ô∏è' : 'ü§ç'}</span> ${p.likes || 0}
                            </button>
                            <button class="action-btn" onclick="toggleCommentBox('${p.id}')">
                                üí¨ ${p.comments ? p.comments.length : 0}
                            </button>
                            ${isOwner ? `
                                <button class="action-btn delete-btn" onclick="deletePost('${p.id}')">üóëÔ∏è</button>
                            ` : ''}
                        </div>
                        ${activePostForComment === p.id ? `
                            <div style="margin-top:1rem;">
                                <input type="text" id="comment-input-${p.id}" placeholder="Write comment..." style="width:70%; padding:0.5rem;">
                                <button onclick="addComment('${p.id}')" style="padding:0.5rem 1rem;">Post</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            feed.innerHTML = html;
        }

        function switchFeed(f) {
            currentFeed = f;
            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (f === 'study') {
                showStudyHub();
            } else {
                document.getElementById('postsFeed').style.display = 'block';
                document.getElementById('studyHubView').style.display = 'none';
                document.getElementById('classFilterBar').style.display = 'none';
                currentClassFilter = null;
                renderFeed();
            }
        }

        // ==================== START ====================
        window.onload = async function() {
            await loadData();
            hideLoading();
            await checkSavedUser();
            
            // Auto-refresh every 15 seconds
            setInterval(async () => {
                if (currentUser) {
                    await loadData();
                    updateProfileDisplay();
                    renderFeed();
                    renderChatList();
                }
            }, 15000);
        };
    </script>
</body>
</html>